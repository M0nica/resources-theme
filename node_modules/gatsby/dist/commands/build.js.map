{"version":3,"sources":["../../src/commands/build.js"],"names":["path","require","report","fs","bootstrap","apiRunnerNode","copyStaticDirs","initTracer","stopTracer","db","signalExit","telemetry","store","readState","queryUtil","structureWebpackErrors","buildUtils","boundActionCreators","cachedPageData","cachedWebpackCompilationHash","process","env","GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES","pageData","webpackCompilationHash","module","exports","build","program","profile","warn","publicDir","join","directory","openTracingConfigFile","buildActivity","phantomActivity","start","trackCli","exitCode","buildSpan","span","setTag","graphqlRunner","parentSpan","processPageQueries","processStaticQueries","getInitialQueryProcessors","graphql","activity","activityTimer","stats","catch","err","panic","end","workerPool","WorkerPool","create","hash","getState","appDataUtil","exists","dispatch","type","payload","write","pages","forEach","_value","key","has","removePageData","id","isTrackingEnabled","bundleSizes","toJson","assets","filter","asset","name","endsWith","map","size","pageDataSizes","pageDataStats","values","addSiteMeasurement","bundleStats","aggregateStats","setProgramStatus","saveState","pagePaths","keys","getChangedPageDataKeys","createProgress","length","stage","context","errorPath","match","message","ref","error","done","deletedPageKeys","collectRemovedPageData","removePageFiles","info","uptime","finish","argv","includes","createdFilesPath","resolve","deletedFilesPath","writeFile"],"mappings":"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","sourcesContent":["/* @flow */\n\nconst path = require(`path`)\nconst report = require(`gatsby-cli/lib/reporter`)\nconst fs = require(`fs-extra`)\nimport { buildHTML } from \"./build-html\"\nimport { buildProductionBundle } from \"./build-javascript\"\nconst bootstrap = require(`../bootstrap`)\nconst apiRunnerNode = require(`../utils/api-runner-node`)\nconst { copyStaticDirs } = require(`../utils/get-static-dir`)\nconst { initTracer, stopTracer } = require(`../utils/tracer`)\nconst db = require(`../db`)\nconst signalExit = require(`signal-exit`)\nconst telemetry = require(`gatsby-telemetry`)\nconst { store, readState } = require(`../redux`)\nconst queryUtil = require(`../query`)\nimport * as appDataUtil from \"../utils/app-data\"\nimport * as WorkerPool from \"../utils/worker/pool\"\nconst { structureWebpackErrors } = require(`../utils/webpack-error-utils`)\nimport {\n  userPassesFeedbackRequestHeuristic,\n  showFeedbackRequest,\n} from \"../utils/feedback\"\nconst buildUtils = require(`../commands/build-utils`)\nconst { boundActionCreators } = require(`../redux/actions`)\nimport { waitUntilAllJobsComplete } from \"../utils/wait-until-jobs-complete\"\n\nlet cachedPageData\nlet cachedWebpackCompilationHash\nif (process.env.GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES) {\n  const { pageData, webpackCompilationHash } = readState()\n  // extract only data that we need to reuse and let v8 garbage collect rest of state\n  cachedPageData = pageData\n  cachedWebpackCompilationHash = webpackCompilationHash\n}\n\ntype BuildArgs = {\n  directory: string,\n  sitePackageJson: object,\n  prefixPaths: boolean,\n  noUglify: boolean,\n  profile: boolean,\n  openTracingConfigFile: string,\n}\n\nmodule.exports = async function build(program: BuildArgs) {\n  if (program.profile) {\n    report.warn(\n      `React Profiling is enabled. This can have a performance impact. See https://www.gatsbyjs.org/docs/profiling-site-performance-with-react-profiler/#performance-impact`\n    )\n  }\n\n  const publicDir = path.join(program.directory, `public`)\n  initTracer(program.openTracingConfigFile)\n  const buildActivity = report.phantomActivity(`build`)\n  buildActivity.start()\n\n  telemetry.trackCli(`BUILD_START`)\n  signalExit(exitCode => {\n    telemetry.trackCli(`BUILD_END`, { exitCode })\n  })\n\n  const buildSpan = buildActivity.span\n  buildSpan.setTag(`directory`, program.directory)\n\n  const { graphqlRunner } = await bootstrap({\n    ...program,\n    parentSpan: buildSpan,\n  })\n\n  const {\n    processPageQueries,\n    processStaticQueries,\n  } = queryUtil.getInitialQueryProcessors({\n    parentSpan: buildSpan,\n  })\n\n  await processStaticQueries()\n\n  await apiRunnerNode(`onPreBuild`, {\n    graphql: graphqlRunner,\n    parentSpan: buildSpan,\n  })\n\n  // Copy files from the static directory to\n  // an equivalent static directory within public.\n  copyStaticDirs()\n\n  let activity = report.activityTimer(\n    `Building production JavaScript and CSS bundles`,\n    { parentSpan: buildSpan }\n  )\n  activity.start()\n  const stats = await buildProductionBundle(program, activity.span).catch(\n    err => {\n      activity.panic(structureWebpackErrors(`build-javascript`, err))\n    }\n  )\n  activity.end()\n\n  const workerPool = WorkerPool.create()\n\n  const webpackCompilationHash = stats.hash\n  if (\n    webpackCompilationHash !== store.getState().webpackCompilationHash ||\n    !appDataUtil.exists(publicDir)\n  ) {\n    store.dispatch({\n      type: `SET_WEBPACK_COMPILATION_HASH`,\n      payload: webpackCompilationHash,\n    })\n\n    activity = report.activityTimer(`Rewriting compilation hashes`, {\n      parentSpan: buildSpan,\n    })\n    activity.start()\n\n    await appDataUtil.write(publicDir, webpackCompilationHash)\n\n    activity.end()\n  }\n\n  await processPageQueries()\n\n  if (process.env.GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES) {\n    const { pages } = store.getState()\n    if (cachedPageData) {\n      cachedPageData.forEach((_value, key) => {\n        if (!pages.has(key)) {\n          boundActionCreators.removePageData({\n            id: key,\n          })\n        }\n      })\n    }\n  }\n\n  if (telemetry.isTrackingEnabled()) {\n    // transform asset size to kB (from bytes) to fit 64 bit to numbers\n    const bundleSizes = stats\n      .toJson({ assets: true })\n      .assets.filter(asset => asset.name.endsWith(`.js`))\n      .map(asset => asset.size / 1000)\n    const pageDataSizes = [...store.getState().pageDataStats.values()]\n\n    telemetry.addSiteMeasurement(`BUILD_END`, {\n      bundleStats: telemetry.aggregateStats(bundleSizes),\n      pageDataStats: telemetry.aggregateStats(pageDataSizes),\n    })\n  }\n\n  require(`../redux/actions`).boundActionCreators.setProgramStatus(\n    `BOOTSTRAP_QUERY_RUNNING_FINISHED`\n  )\n\n  await db.saveState()\n\n  await waitUntilAllJobsComplete()\n\n  // we need to save it again to make sure our latest state has been saved\n  await db.saveState()\n\n  let pagePaths = [...store.getState().pages.keys()]\n\n  // Rebuild subset of pages if user opt into GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES\n  // if there were no source files (for example components, static queries, etc) changes since last build, otherwise rebuild all pages\n  if (\n    process.env.GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES &&\n    cachedWebpackCompilationHash === store.getState().webpackCompilationHash\n  ) {\n    pagePaths = buildUtils.getChangedPageDataKeys(\n      store.getState(),\n      cachedPageData\n    )\n  }\n\n  activity = report.createProgress(\n    `Building static HTML for pages`,\n    pagePaths.length,\n    0,\n    {\n      parentSpan: buildSpan,\n    }\n  )\n  activity.start()\n  try {\n    await buildHTML({\n      program,\n      stage: `build-html`,\n      pagePaths,\n      activity,\n      workerPool,\n    })\n  } catch (err) {\n    let id = `95313` // TODO: verify error IDs exist\n    const context = {\n      errorPath: err.context && err.context.path,\n    }\n\n    const match = err.message.match(\n      /ReferenceError: (window|document|localStorage|navigator|alert|location) is not defined/i\n    )\n    if (match && match[1]) {\n      id = `95312`\n      context.ref = match[1]\n    }\n\n    activity.panic({\n      id,\n      context,\n      error: err,\n    })\n  }\n  activity.done()\n\n  let deletedPageKeys = []\n  if (process.env.GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES) {\n    activity = report.activityTimer(`Delete previous page data`)\n    activity.start()\n    deletedPageKeys = buildUtils.collectRemovedPageData(\n      store.getState(),\n      cachedPageData\n    )\n    await buildUtils.removePageFiles({ publicDir }, deletedPageKeys)\n\n    activity.end()\n  }\n\n  activity = report.activityTimer(`onPostBuild`, { parentSpan: buildSpan })\n  activity.start()\n  await apiRunnerNode(`onPostBuild`, {\n    graphql: graphqlRunner,\n    parentSpan: buildSpan,\n  })\n  activity.end()\n\n  // Make sure we saved the latest state so we have all jobs cached\n  await db.saveState()\n\n  report.info(`Done building in ${process.uptime()} sec`)\n\n  buildSpan.finish()\n  await stopTracer()\n  workerPool.end()\n  buildActivity.end()\n\n  if (\n    process.env.GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES &&\n    process.argv.includes(`--log-pages`)\n  ) {\n    if (pagePaths.length) {\n      report.info(\n        `Built pages:\\n${pagePaths\n          .map(path => `Updated page: ${path}`)\n          .join(`\\n`)}`\n      )\n    }\n\n    if (deletedPageKeys.length) {\n      report.info(\n        `Deleted pages:\\n${deletedPageKeys\n          .map(path => `Deleted page: ${path}`)\n          .join(`\\n`)}`\n      )\n    }\n  }\n\n  if (\n    process.env.GATSBY_EXPERIMENTAL_PAGE_BUILD_ON_DATA_CHANGES &&\n    process.argv.includes(`--write-to-file`)\n  ) {\n    const createdFilesPath = path.resolve(\n      `${program.directory}/.cache`,\n      `newPages.txt`\n    )\n    const deletedFilesPath = path.resolve(\n      `${program.directory}/.cache`,\n      `deletedPages.txt`\n    )\n\n    if (pagePaths.length) {\n      await fs.writeFile(createdFilesPath, `${pagePaths.join(`\\n`)}\\n`, `utf8`)\n      report.info(`.cache/newPages.txt created`)\n    }\n    if (deletedPageKeys.length) {\n      await fs.writeFile(\n        deletedFilesPath,\n        `${deletedPageKeys.join(`\\n`)}\\n`,\n        `utf8`\n      )\n      report.info(`.cache/deletedPages.txt created`)\n    }\n  }\n\n  if (await userPassesFeedbackRequestHeuristic()) {\n    showFeedbackRequest()\n  }\n}\n"],"file":"build.js"}